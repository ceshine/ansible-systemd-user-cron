---
- name: Manage Scheduled Tasks
  hosts: localhost
  connection: local
  gather_facts: yes

  # 1. Load variables from our separate config file
  vars_files:
    - configs/regular.yml

  vars:
    systemd_user_dir: "{{ ansible_env.HOME }}/.config/systemd/user"

    # Generate the expected file names dynamically using the task_prefix
    # The '~' operator in Jinja2 connects strings together
    expected_files: >-
      {{
        (scheduled_tasks | map(attribute='name') | map('regex_replace', '^(.*)$', task_prefix ~ '\1.service') | list) +
        (scheduled_tasks | map(attribute='name') | map('regex_replace', '^(.*)$', task_prefix ~ '\1.timer') | list)
      }}

  tasks:
    - name: Ensure systemd user directory exists
      ansible.builtin.file:
        path: "{{ systemd_user_dir }}"
        state: directory

    - name: Assert task_prefix is non-empty
      ansible.builtin.assert:
        that:
          - task_prefix is string
          - task_prefix | trim | length > 0
        fail_msg: "task_prefix must be a non-empty string."

    - name: Validate scheduled task commands
      ansible.builtin.assert:
        that:
          - item.command is string
          - item.command | trim | length > 0
          - item.working_directory is not defined or item.working_directory is string
          - item.working_directory is not defined or item.working_directory | trim | length > 0
          - (item.use_shell | default(false)) or (item.command is match("^[^|&;<>()$`]+$"))
        fail_msg: >-
          Invalid command or working_directory for '{{ item.name }}'.
          Non-shell command contains shell syntax, or working_directory is not a non-empty string.
          Set use_shell: true if shell syntax is intentional.
      loop: "{{ scheduled_tasks }}"

    - name: Validate scheduled task timer config
      ansible.builtin.assert:
        that:
          - not (item.schedule is defined and item.timer is defined)
          - item.schedule is defined or item.timer is defined
          - item.schedule is not defined or item.schedule | trim | length > 0
          - item.timer is not defined or item.timer is mapping
          - >-
            item.timer is not defined or
            item.timer.on_calendar is defined or
            item.timer.on_boot_sec is defined or
            item.timer.on_unit_active_sec is defined or
            item.timer.on_unit_inactive_sec is defined
          - item.timer is not defined or item.timer.on_calendar is not defined or item.timer.on_calendar | trim | length > 0
        fail_msg: >-
          Invalid timer config for '{{ item.name }}'.
          Ensure you are not using 'schedule' and 'timer' together.
          If using 'timer', ensure at least one trigger (e.g., on_calendar, on_boot_sec) is defined.
      loop: "{{ scheduled_tasks }}"

    - name: Generate systemd services
      ansible.builtin.template:
        src: templates/service.j2
        dest: "{{ systemd_user_dir }}/{{ task_prefix }}{{ item.name }}.service"
      loop: "{{ scheduled_tasks }}"
      notify: Reload Systemd User

    - name: Generate systemd timers
      ansible.builtin.template:
        src: templates/timer.j2
        dest: "{{ systemd_user_dir }}/{{ task_prefix }}{{ item.name }}.timer"
      loop: "{{ scheduled_tasks }}"
      notify: Reload Systemd User

    - name: Find existing managed systemd files
      ansible.builtin.find:
        paths: "{{ systemd_user_dir }}"
        patterns: "{{ task_prefix }}*"
      register: found_files

    - name: Identify orphaned files
      ansible.builtin.set_fact:
        orphans: "{{ found_files.files | map(attribute='path') | map('basename') | difference(expected_files) }}"

    - name: Stop and disable orphaned timers
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: stopped
        enabled: false
        scope: user
      loop: "{{ orphans }}"
      when: item.endswith('.timer')

    - name: Delete orphaned systemd files
      ansible.builtin.file:
        path: "{{ systemd_user_dir }}/{{ item }}"
        state: absent
      loop: "{{ orphans }}"
      notify: Reload Systemd User

    - name: Flush handlers before enabling timers
      ansible.builtin.meta: flush_handlers

    - name: Enable and start desired timers
      ansible.builtin.systemd:
        name: "{{ task_prefix }}{{ item.name }}.timer"
        state: started
        enabled: true
        scope: user
      loop: "{{ scheduled_tasks }}"

  handlers:
    - name: Reload Systemd User
      ansible.builtin.systemd:
        daemon_reload: true
        scope: user
